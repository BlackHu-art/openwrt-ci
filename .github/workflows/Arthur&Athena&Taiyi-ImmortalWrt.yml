name: Arthur&Athena&Taiyi-ImmortalWrt

# è‡ªåŠ¨ç¼–è¯‘ï¼šå½“ Auto-Clean è¿è¡Œå®ŒæˆåŽ æˆ– æ‰‹åŠ¨è§¦å‘ / è¢«å…¶ä»– workflow è°ƒç”¨
on:
  workflow_run:
    workflows: ["Auto-Clean"]
    types:
      - completed
  workflow_dispatch:
  workflow_call:
  # schedule:
  #   - cron: 0 20 * * *

# CI æƒé™
permissions: write-all

env:
  REPO_URL: "https://github.com/laipeng668/immortalwrt.git"
  REPO_BRANCH: "master"
  CONFIG_FILE: "configs/Arthur&Athena&Taiyi.config"
  GENERAL_CONFIG_FILE: "configs/General.config"
  DIY_SCRIPT: "scripts/Roc-script.sh"
  CLASH_KERNEL: "amd64"
  UPLOAD_BIN_DIR: "false"
  FIRMWARE_RELEASE: "true"
  FIRMWARE_TAG: "Arthur&Athena&Taiyi"
  TZ: "Asia/Shanghai"

jobs:
  Build:
    runs-on: ubuntu-24.04
    steps:

    - name: Check Server Performance(æ£€æŸ¥æœåŠ¡å™¨æ€§èƒ½)
      run: |
        echo "è­¦å‘Šâš "
        echo "åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œè‹¥é€‰æ‹©çš„æ’ä»¶è¿‡å¤šï¼ŒåŠ¡å¿…æ³¨æ„CPUæ€§èƒ½ï¼"
        echo -e "å·²çŸ¥CPUåž‹å·ï¼ˆé™åºï¼‰ï¼š7763ï¼Œ8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673 \n"
        echo "--------------------------CPUä¿¡æ¯--------------------------"
        echo "CPUç‰©ç†æ•°é‡ï¼š$(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
        echo -e "CPUæ ¸å¿ƒä¿¡æ¯ï¼š$(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
        echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
        echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯ï¼š"
        echo -e "$(sudo lshw -short -C memory | grep GiB) \n"
        echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
        echo "ç¡¬ç›˜æ•°é‡ï¼š$(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT

    - name: Initialization Environment(åˆå§‹åŒ–çŽ¯å¢ƒ)
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -y update
        sudo -E apt-get -y install $(curl -fsSL ophub.org/ubuntu2404-make-openwrt-depends)
        sudo -E systemctl daemon-reload
        sudo timedatectl set-timezone "$TZ"

    - name: Checkout(æ£€å‡ºä»£ç )
      uses: actions/checkout@v4

    - name: Clone Source Code(å…‹éš†æºä»£ç )
      run: |
        df -hT $GITHUB_WORKSPACE
        sudo mkdir -p /mnt/openwrt
        sudo chown -R $(id -u):$(id -g) /mnt/openwrt
        git clone --depth 1 -b $REPO_BRANCH --single-branch $REPO_URL /mnt/openwrt
        cd /mnt/openwrt
        echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
        VERSION_KERNEL=$(grep -oP 'LINUX_KERNEL_HASH-\K[0-9]+\.[0-9]+\.[0-9]+' target/linux/generic/kernel-6.12 || true)
        echo "VERSION_KERNEL=$VERSION_KERNEL" >> $GITHUB_ENV

    - name: Generate Variables(ç”Ÿæˆå˜é‡)
      run: |
        cp "$CONFIG_FILE" "$OPENWRT_PATH/.config"
        cd $OPENWRT_PATH
        make defconfig > /dev/null 2>&1 || true
        SOURCE_REPO="$(echo $REPO_URL | awk -F '/' '{print $(NF)}')"
        echo "SOURCE_REPO=$SOURCE_REPO" >> $GITHUB_ENV
        DEVICE_TARGET=$(grep -m1 CONFIG_TARGET_BOARD .config | awk -F '"' '{print $2}' || echo unknown)
        echo "DEVICE_TARGET=$DEVICE_TARGET" >> $GITHUB_ENV
        DEVICE_SUBTARGET=$(grep -m1 CONFIG_TARGET_SUBTARGET .config | awk -F '"' '{print $2}' || echo unknown)
        echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> $GITHUB_ENV
        echo "HASH=$(git -C $OPENWRT_PATH rev-parse --short HEAD)" >> $GITHUB_ENV
        echo "CACHE_DATE=$(date +"%Y-%m-%d_%H-%M-%S")" >> $GITHUB_ENV

    - name: Cache Toolchain(ç¼“å­˜å·¥å…·é“¾)
      uses: actions/cache@v4
      with:
        # æ³¨æ„ï¼šåŽ»æŽ‰ç©ºæ ¼ï¼Œä½¿ç”¨ - è¿žæŽ¥ï¼Œé¿å…ç¼“å­˜ key æ— æ•ˆ
        key: ${{ env.SOURCE_REPO }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.HASH }}-${{ env.CACHE_DATE }}
        restore-keys: |
          ${{ env.SOURCE_REPO }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-
        path: |
          ${{ env.OPENWRT_PATH }}/.ccache
          ${{ env.OPENWRT_PATH }}/staging_dir

    - name: Refresh The Cache (optional - commented safer) (åˆ·æ–°ç¼“å­˜)
      run: |
        # é«˜é£Žé™©ï¼šæ‰¹é‡ touch stamp æ–‡ä»¶ä¼šé˜»æ­¢åŒ…é‡ç¼–è¯‘å¯¼è‡´æ½œåœ¨é“¾æŽ¥/è¿è¡Œæ—¶é”™è¯¯
        # å¦‚æžœä½ ç¡®å®šè¦ä¿ç•™ç¼“å­˜å¯ä»¥å¯ç”¨æ­¤æ®µï¼Œå¦åˆ™ä¿æŒæ³¨é‡Šã€‚
        # if [ -d "$OPENWRT_PATH/staging_dir" ]; then
        #   find "$OPENWRT_PATH/staging_dir" -type d -name "stamp" -not -path "*target*" | while read -r dir; do
        #       find "$dir" -type f -exec touch {} +
        #   done
        # fi
        echo "Skipped touching stamp files (recommended)."

    - name: Load Custom Configuration(åŠ è½½è‡ªå®šä¹‰é…ç½® - åœ¨ feeds update ä¹‹å‰æ‰§è¡Œ)
      run: |
        # æŠŠ DIY è„šæœ¬æ”¾åˆ°æºç æ ‘å¹¶æ‰§è¡Œï¼Œä»¥ä¾¿è¿›è¡Œ feeds åˆ æ”¹/æ›¿æ¢å·¥ä½œåœ¨ feeds update/install ä¹‹å‰ç”Ÿæ•ˆ
        chmod +x $DIY_SCRIPT
        cd $OPENWRT_PATH
        echo "è¿è¡Œè‡ªå®šä¹‰è„šæœ¬ $GITHUB_WORKSPACE/$DIY_SCRIPT"
        $GITHUB_WORKSPACE/$DIY_SCRIPT

    - name: Install Feeds(å®‰è£…feeds)
      run: |
        cd $OPENWRT_PATH
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Deploy Custom Banner(ä¿®æ”¹åŽŸæœ‰Banner)
      run: |
        # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
        mkdir -p "$OPENWRT_PATH/package/base-files/files/etc"
        # é™é»˜æ¨¡å¼å¤åˆ¶ï¼ˆæ–‡ä»¶å­˜åœ¨åˆ™è¦†ç›–ï¼Œä¸å­˜åœ¨åˆ™è·³è¿‡ï¼‰
        if [ -f "$GITHUB_WORKSPACE/configs/banner" ]; then
          echo "æ£€æµ‹åˆ°è‡ªå®šä¹‰banneræ–‡ä»¶ï¼Œæ­£åœ¨åº”ç”¨..."
          cp -f "$GITHUB_WORKSPACE/configs/banner" "$OPENWRT_PATH/package/base-files/files/etc/"
          echo "æ–‡ä»¶å†…å®¹éªŒè¯:"
          cat "$OPENWRT_PATH/package/base-files/files/etc/banner"
        else
          echo "æœªæä¾›è‡ªå®šä¹‰banneræ–‡ä»¶ï¼Œä¿æŒOpenWrté»˜è®¤é…ç½®"
        fi
      continue-on-error: true

    - name: Download DL Package(ä¸‹è½½DLè½¯ä»¶åŒ…)
      run: |
        # åˆå¹¶ configï¼Œä»Žè€Œç¡®ä¿ .config åŒ…å«ä¸¤ä»½é…ç½®ï¼ˆCustom + Generalï¼‰
        cat "$CONFIG_FILE" "$GENERAL_CONFIG_FILE" > $OPENWRT_PATH/.config
        cd $OPENWRT_PATH
        make defconfig
        # å…ˆå°è¯•å¹¶è¡Œä¸‹è½½ï¼Œè‹¥ runner å†…å­˜ä¸è¶³ï¼ŒåŽç»­ç¼–è¯‘æœ‰å›žé€€æœºåˆ¶
        make download -j$(nproc)

    - name: Compile Firmware(å¼€å§‹ç¼–è¯‘å›ºä»¶)
      id: compile
      run: |
        cd $OPENWRT_PATH
        echo -e "$(nproc) thread compile"
        # å…ˆå¹¶å‘ç¼–è¯‘ï¼Œå¤±è´¥åŽå›žé€€åˆ°å•çº¿ç¨‹ä»¥ä¾¿è¾“å‡ºè¯¦ç»†æ—¥å¿—
        if make -j$(nproc); then
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œåˆ‡æ¢è‡³å•çº¿ç¨‹é‡è¯•å¹¶æ‰“å°è¯¦ç»†æ—¥å¿—"
          if make -j1 V=s; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi
        fi
        echo "DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
        echo "FILE_DATE=$(date +"%Y.%m.%d")" >> $GITHUB_ENV

    - name: Check Space Usage(æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ)
      if: (!cancelled())
      run: df -hT

    - name: Upload Bin Directory(ä¸Šä¼ å›ºä»¶)
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.SOURCE_REPO }}-bin-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
        path: ${{ env.OPENWRT_PATH }}/bin

    - name: Organize Files(æ•´ç†æ–‡ä»¶)
      if: steps.compile.outputs.status == 'success'
      run: |
        cd $OPENWRT_PATH/bin/targets/*/*
        # ä¿å­˜ .config ä½œä¸ºå‘½åå‚è€ƒ
        cp $OPENWRT_PATH/.config Arthur.Athena.Taiyi.config
        mv config.buildinfo Arthur.Athena.Taiyi.config.buildinfo || true
        mv immortalwrt-qualcommax-ipq60xx.manifest immortalwrt-qualcommax-ipq60xx-Arthur.Athena.Taiyi.manifest || true
        # æ³¨æ„ï¼šOpenWrt ç”Ÿæˆçš„æ˜¯ .ipk åŒ…ï¼Œè€Œä¸æ˜¯ .apk
        mkdir -p packages || true
        mv -f $OPENWRT_PATH/bin/packages/*/*/*.ipk packages || true
        tar -zcf Arthur.Athena.Taiyi.Packages.tar.gz packages || true
        rm -rf packages feeds.buildinfo version.buildinfo sha256sums profiles.json || true
        echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV

    - name: Upload Firmware To Artifact(å°†å›ºä»¶ä¸Šä¼ åˆ°Artifact)
      if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.SOURCE_REPO }}-firmware-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE_PATH }}

    - name: Upload Firmware To Release(å‘å¸ƒå›ºä»¶)
      if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
      uses: ncipollo/release-action@v4
      with:
        name: ${{ env.DATE }} for ${{ env.FIRMWARE_TAG }}
        allowUpdates: true
        tag: ${{ env.FIRMWARE_TAG }}
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: ${{ env.FIRMWARE_PATH }}/*
        body: |
          **This is OpenWrt Firmware for ${{ env.FIRMWARE_TAG }}**
          ### ðŸ“’ å›ºä»¶ä¿¡æ¯
          - è¿™æ˜¯å¼€å¯å…¨åŠŸèƒ½NSSçš„6.12å†…æ ¸å›ºä»¶ï¼Œé»˜è®¤ä¸»é¢˜ä¸ºArgonï¼›è¯¥å›ºä»¶åœ¨ImmortalWrtçš„åŸºç¡€ä¸Šï¼Œæ·»åŠ äº†é¢å¤–çš„è½¯ä»¶åŒ…cpufreqã€ddnsã€ttydã€upnpã€wolplusã€samba4ã€vlmcsdã€aria2ã€autorebootã€uhttpdã€wifischeduleã€frpsã€frpcã€diskmanã€hd-idleã€banipã€acmeã€arpbindã€usb-printerã€homeproxyã€openlistã€adguardhomeã€oafã€sqmã€wireguardã€watchcatã€3catï¼ˆ**Taiyi**é¢å¤–å¢žåŠ äº†filebrowserã€dockermanã€gecoosacã€luckyï¼‰ï¼Œå¹¶æ·»åŠ äº†è‹¥å¹²å·¥å…·ï¼Œå…·ä½“è¯¦è§å¯¹åº”æœºåž‹çš„configã€‚
          - ðŸ’» è¿™æ˜¯ ${{ env.FIRMWARE_TAG }} å¹³å°ä½¿ç”¨çš„ OpenWrt å›ºä»¶
          - ðŸŒ é»˜è®¤åœ°å€: **10.0.0.1**
          - ðŸ”‘ é»˜è®¤å¯†ç : none
          ### ðŸ§Š å›ºä»¶ç‰ˆæœ¬
          - å›ºä»¶å†…æ ¸ç‰ˆæœ¬ï¼š**${{ env.VERSION_KERNEL }}**
          - å›ºä»¶ç¼–è¯‘å‰æœ€åŽä¸€æ¬¡âž¦[ä¸»æºç ](${{ env.REPO_URL }})æ›´æ–°è®°å½•

    - name: Delete Old Cache(åˆ é™¤æ—§ç¼“å­˜)
      run: |
        # å»ºè®®ï¼šä»…åˆ é™¤éžå¸¸æ—§æˆ–ä¸éœ€è¦çš„ keyï¼Œé¿å…ä¸€æ¬¡æ€§åˆ é™¤å…¨éƒ¨ç¼“å­˜
        # å¦‚æžœä»éœ€æ¸…ç†ï¼Œå¯æŠŠä¸‹é¢æ³¨é‡Šè§£é™¤å¹¶æ ¹æ®éœ€è¦è°ƒæ•´ key å‰ç¼€
        # gh cache list --key ${{ env.SOURCE_REPO }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}- --json key --jq '.[] | .key' | while read -r key; do
        #   gh cache delete "$key"
        # done

        echo "========cache status========"
        echo "ccache: $(du -sh $OPENWRT_PATH/.ccache 2>/dev/null | cut -f 1 || echo '0')"
        echo "staging: $(du -sh $OPENWRT_PATH/staging_dir 2>/dev/null | cut -f 1 || echo '0')"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
